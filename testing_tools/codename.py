#!/usr/bin/env python3


'''
SSH Version Codename
--------------------
Description: Find distribution codename by SSH version in launchpad software
Author: Marss
Date: 28, Aug 2023
'''

from os import path
from re import findall
from requests import get
from requests.packages import urllib3
from signal import signal, SIGINT
from sys import argv

import pdb

# Ctrl + c
signal(SIGINT, lambda signum, frame: exit('\n[-] User aborted.'))

# disable warnings
urllib3.disable_warnings()

def print_table(openssh: str, codename: str, launchpad_url: str):
    
    table = '''
    SSH Version Codename
    --------------------
    SSH Version: %s
    Codename: %s
    Launchpad: %s
    ''' % (openssh, codename, launchpad_url)
    
    print(table)

def get_codename_data(openssh_version):

    try:
        launchpad_site = 'https://launchpad.net'

        if 'Debian' in openssh_version:
            # https://launchpad.net/debian/+source/openssh/1:8.4p1-5+deb11u1
            # OpenSSH_8.4p1 Debian-5+deb11u1
            # openssh (1:8.4p1-5+deb11u1) bullseye; urgency=medium
            openssh = openssh_version.lower().replace(' ','').replace('_','/1:').replace('debian','')
            launchpad_site = launchpad_site + '/debian/+source/' + openssh

        elif 'Ubuntu' in openssh_version:
            # OpenSSH_8.9p1 Ubuntu-3ubuntu0.3
            # https://launchpad.net/ubuntu/+source/openssh/1:8.9p1-3ubuntu0.3
            # openssh (1:8.9p1-3ubuntu0.3) jammy-security; urgency=medium
            openssh = openssh_version.lower().replace(' ','').replace('_','/1:').replace('ubuntu','', 1)
            launchpad_site = launchpad_site + '/ubuntu/+source/' + openssh
        
        response = get(launchpad_site, verify=False)
        
        codename = findall(r'openssh \(.*?\) (.*);', response.text)[0]
        
        return codename, launchpad_site

    except Exception as error:
        exit('\n[x] Error: ' + repr(error))


# Main flow
if __name__ == '__main__':

    if len(argv) != 2:
        exit(f'\n[*] Usage: python3 {argv[0]} "OpenSSH_8.4p1 Debian-5+deb11u1"')

    codename, url = get_codename_data(argv[1])
    print_table(argv[1], codename, url)